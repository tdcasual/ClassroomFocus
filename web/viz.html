<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Classroom Focus Analyzer</title>
    <link rel="stylesheet" href="./viz.css" />
  </head>
  <body>
    <div class="app" id="app">
      <header class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="brand-title">
            <div class="title">Classroom Focus Analyzer</div>
            <div class="subtitle">睡眠/低头检测 · 语音识别 · 知识点对齐</div>
          </div>
        </div>

	        <div class="topbar-right">
	          <div class="pill" title="WebSocket 连接状态">
	            <span class="dot unknown" id="wsDot"></span>
	            <span id="wsStatus">disconnected</span>
	          </div>
	          <div class="pill" title="当前会话">
	            <span class="dot unknown" id="recDot"></span>
	            <span id="recStatusText">idle</span>
	            <span class="mono" id="sessionIdText" style="display:none;"></span>
	          </div>
	          <button class="pill pill-btn" id="btnModelCenter" title="模型设置：录制前检测/切换在线/离线/ASR">
	            <span class="dot unknown" id="modelDot"></span>
	            <span id="modelStatusText">模型设置</span>
	          </button>

	          <button class="btn primary" id="btnStart">开始录制</button>
	          <button class="btn danger" id="btnStop" disabled>停止</button>
	          <button class="btn" id="btnReport" disabled>生成报告</button>
	          <button class="btn ghost" id="btnOpenReport" style="display:none;">查看报告</button>
        </div>
      </header>

      <div class="content">
        <aside class="sidebar">
          <div class="sidebar-head">
            <div class="sidebar-head-row">
              <div class="input" title="按学生 ID 过滤">
                <input id="studentFilter" placeholder="搜索学生 ID（track_id）…" autocomplete="off" />
              </div>
              <div class="select" title="时间窗">
                <span>窗口</span>
                <select id="windowSel">
                  <option value="30">30s</option>
                  <option value="60" selected>60s</option>
                  <option value="120">120s</option>
                  <option value="300">300s</option>
                </select>
              </div>
            </div>
            <div class="sidebar-head-row">
              <div class="select" title="历史会话（out/session_*/stats.json）">
                <span>历史</span>
                <select id="sessionSelect">
                  <option value="">（加载中…）</option>
                </select>
              </div>
              <button class="btn small" id="btnRefreshSessions" title="刷新会话列表">刷新</button>
            </div>
          </div>
          <div class="student-list" id="studentList">
            <div class="muted" style="padding:8px 4px;">等待人脸轨迹数据…</div>
          </div>
        </aside>

        <main class="main">
          <section class="panel">
            <div class="panel-head">
              <div class="panel-title">实时画面</div>
              <div class="panel-actions">
                <label class="toggle"><input type="checkbox" id="toggleBoxes" checked />框选</label>
                <label class="toggle"><input type="checkbox" id="toggleLabels" checked />状态</label>
                <label class="toggle"><input type="checkbox" id="toggleAsr" checked />ASR</label>
                <span class="pill" title="渲染帧率"><span class="dot unknown" id="fpsDot"></span><span id="fpsText">0 fps</span></span>
              </div>
            </div>
            <div class="preview-wrap">
              <canvas id="preview"></canvas>
            </div>
            <div class="inspector" id="liveInspector">
              <span><strong>选中学生：</strong><span id="selectedStudentText">—</span></span>
              <span><strong>时间：</strong><span class="mono" id="nowText">0.00s</span></span>
              <span><strong>讲解：</strong><span id="asrNowText" class="muted">（暂无 ASR 段）</span></span>
            </div>
          </section>

          <section class="panel">
            <div class="panel-head">
              <div class="panel-title">时间轴（点击取点对齐内容）</div>
              <div class="panel-actions">
                <button class="btn small" id="btnFollow">跟随实时</button>
                <button class="btn small" id="btnClearCursor" disabled>清除游标</button>
              </div>
            </div>
            <canvas id="timeline" class="timeline-canvas"></canvas>
            <div class="inspector" id="cursorInspector" style="display:none;">
              <span><strong>游标：</strong><span class="mono" id="cursorTimeText">—</span></span>
              <span><strong>状态：</strong><span id="cursorStateText">—</span></span>
              <span><strong>讲解：</strong><span id="cursorAsrText" class="muted">—</span></span>
            </div>
          </section>
        </main>
      </div>

	      <div class="modal" id="reportModal" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
	        <div class="drawer">
	          <div class="drawer-head">
	            <div class="drawer-title" id="reportTitle">学习情况报告（睡眠区间 × 讲解内容/知识点）</div>
	            <div style="display:flex; gap:10px; align-items:center;">
	              <button class="btn small" id="btnReloadReport" title="重新拉取统计结果">重载</button>
	              <button class="btn small" id="btnCloseReport">关闭</button>
	            </div>
	          </div>
	          <div class="drawer-body">
	            <div class="kpi-row" id="reportKpis"></div>
	            <div class="links" id="reportLinks"></div>
	            <div id="reportBody" class="muted">尚未生成报告。停止录制后点击“生成报告”。</div>
	          </div>
	        </div>
	      </div>

	      <div class="modal model-modal" id="modelModal" role="dialog" aria-modal="true" aria-labelledby="modelTitle">
	        <div class="drawer model-drawer" id="modelDrawer" role="document">
	          <div class="drawer-head model-head">
	            <div class="model-head-left">
	              <div class="drag-handle" id="modelDragHandle" title="拖动窗口"></div>
	            <div class="model-head-title">
	                <div class="drawer-title" id="modelTitle">模型设置（录制前检测）</div>
	                <div class="model-subtitle">拖动窗口，可在不遮挡实时画面的情况下调整设置。</div>
	              </div>
	            </div>
	            <div class="model-head-actions">
	              <button class="btn small" id="btnModelsSave" title="保存并应用到下一次录制">保存/应用</button>
	              <button class="btn small" id="btnModelsCheck" title="快速检测（推荐）">检测</button>
	              <button class="btn small" id="btnModelsCheckDeep" title="深度检测（会触发真实 ASR 调用）">深度检测</button>
	              <button class="btn small" id="btnModelsResetPos" title="重置窗口位置">重置位置</button>
	              <button class="btn small" id="btnModelsClose">关闭</button>
	            </div>
		          </div>
		          <div class="drawer-body model-body">
			            <div class="model-layout">
			              <aside class="model-nav" aria-label="模型设置导航">
		                <button class="model-nav-btn active" type="button" data-target="model-section-check">检测结果</button>
		                <button class="model-nav-btn" type="button" data-target="model-section-mode">模式</button>
		                <button class="model-nav-btn" type="button" data-target="model-section-llm">LLM</button>
		                <button class="model-nav-btn" type="button" data-target="model-section-asr">ASR</button>
		                <button class="model-nav-btn" type="button" data-target="model-section-env">环境摘要</button>
		              </aside>
			              <div class="model-content" id="modelContent">
			                <section class="model-section" id="model-section-check">
			                  <div class="model-section-head">
			                    <div class="summary-left">
			                      <div class="student-name">检测结果</div>
			                      <span class="badge"><span class="dot unknown"></span><span>建议录制前检测</span></span>
			                    </div>
			                    <div class="summary-right">将检测结果作为“是否需要 offline”的依据</div>
			                  </div>
			                  <div class="model-section-body">
			                    <div id="modelCheckBox" class="muted">尚未检测。</div>
			                  </div>
			                </section>

			                <section class="model-section" id="model-section-mode">
			                  <div class="model-section-head">
			                    <div class="summary-left">
			                      <div class="student-name">模式</div>
			                      <span class="badge"><span class="dot unknown"></span><span>online / offline</span></span>
			                    </div>
			                    <div class="summary-right">offline 不会调用任何模型</div>
			                  </div>
			                  <div class="model-section-body">
			                    <div class="field">
			                      <div class="field-label">模式（Recording 不受影响）</div>
			                      <div class="select">
			                        <span>Mode</span>
			                        <select id="modelModeSel">
			                          <option value="online">online（调用模型）</option>
			                          <option value="offline">offline（不调用模型）</option>
			                        </select>
			                      </div>
			                      <div class="field-help">离线模式仍会录制音视频并生成 CV 统计，但报告将跳过 ASR/LLM。</div>
			                    </div>
			                  </div>
			                </section>

			                <section class="model-section" id="model-section-llm">
			                  <div class="model-section-head">
			                    <div class="summary-left">
			                      <div class="student-name">LLM（课程总结 / 知识点）</div>
			                      <span class="badge"><span class="dot unknown"></span><span>OpenAI-compatible</span></span>
			                    </div>
			                    <div class="summary-right">可接 OpenAI / OpenRouter 等兼容服务（含 Claude 等）</div>
			                  </div>
			                  <div class="model-section-body">
			                    <div class="field-row">
			                      <label class="toggle"><input type="checkbox" id="llmEnabledToggle" />启用 LLM（总结+知识点）</label>
			                    </div>
			                    <div class="form-grid">
			                      <div class="field">
			                        <div class="field-label">Base URL</div>
			                        <div class="input">
			                          <input id="llmBaseUrlInput" placeholder="https://api.openai.com 或 https://openrouter.ai/api/v1" autocomplete="off" />
			                        </div>
			                        <div class="field-help">后端会自动补齐/规范化 `/v1` 路径，并兼容 GPT-5+ 与旧式 Chat Completions。</div>
			                      </div>
			                      <div class="field">
			                        <div class="field-label">API Key</div>
			                        <div class="input">
			                          <input id="llmApiKeyInput" type="password" placeholder="sk-...（不会写入 out/ session 输出）" autocomplete="off" />
			                        </div>
			                        <div class="field-help">如不填写则回退使用环境变量：`OPENAI_API_KEY` / `OPENAI_KEY`。</div>
			                      </div>
			                      <div class="field">
			                        <div class="field-label">可用模型（从 URL 拉取）</div>
			                        <div style="display:flex; gap:10px; align-items:center;">
			                          <div class="select" style="flex:1; min-width:0;">
			                            <span>Model</span>
			                            <select id="llmModelSel">
			                              <option value="">（点击“拉取模型”）</option>
			                            </select>
			                          </div>
			                          <button class="btn small" id="btnLlmPullModels" title="从当前 Base URL 拉取 /v1/models">拉取模型</button>
			                        </div>
			                        <div id="llmModelsStatus" class="muted">（未拉取）</div>
			                        <div class="field-help">如拉取失败，可直接在下方手动填写模型名。</div>
			                      </div>
			                      <div class="field">
			                        <div class="field-label">模型名（手动/被下拉框填入）</div>
			                        <div class="input">
			                          <input id="llmModelInput" placeholder="gpt-4o-mini / gpt-5 / anthropic/claude-... / ..." autocomplete="off" />
			                        </div>
			                      </div>
			                    </div>
			                  </div>
			                </section>

			                <section class="model-section" id="model-section-asr">
			                  <div class="model-section-head">
			                    <div class="summary-left">
			                      <div class="student-name">ASR（整节课转写）</div>
			                      <span class="badge"><span class="dot unknown"></span><span>provider</span></span>
			                    </div>
			                    <div class="summary-right">用于“睡觉时间 × 讲课内容”对齐</div>
			                  </div>
			                  <div class="model-section-body">
			                    <div class="form-grid">
			                      <div class="field">
			                        <div class="field-label">ASR Provider</div>
			                        <div class="select">
			                          <span>Provider</span>
			                          <select id="asrProviderSel">
			                            <option value="openai_compat">OpenAI-compatible（Whisper）</option>
			                            <option value="dashscope">阿里 DashScope（文件识别）</option>
			                            <option value="xfyun_raasr">讯飞 RaaSR（录音文件识别）</option>
			                            <option value="none">none（不转写）</option>
			                          </select>
			                        </div>
			                        <div class="field-help">DashScope Key：`DASH_SCOPE_API_KEY`；讯飞：`XFYUN_APP_ID`/`XFYUN_SECRET_KEY`。</div>
			                      </div>
			                      <div class="field">
			                        <div class="field-label">ASR 模型</div>
			                        <div class="input" title="OpenAI ASR model 或 DashScope model（讯飞不需要）">
			                          <input id="asrModelInput" placeholder="whisper-1 / fun-asr-realtime / ..." autocomplete="off" />
			                        </div>
			                        <div class="field-help">建议：录制前先“检测”，避免报告生成时才发现不可用。</div>
			                      </div>
			                    </div>
			                  </div>
			                </section>

			                <section class="model-section" id="model-section-env">
			                  <div class="model-section-head">
			                    <div class="summary-left">
			                      <div class="student-name">环境摘要（.env）</div>
			                      <span class="badge"><span class="dot unknown"></span><span>keys present?</span></span>
			                    </div>
			                    <div class="summary-right">仅展示是否存在，不会回显 Key</div>
			                  </div>
			                  <div class="model-section-body">
			                    <div id="modelEnvBox" class="muted">（加载中…）</div>
			                  </div>
			                </section>
			              </div>
		            </div>
		          </div>
		        </div>
		      </div>
	    </div>

	    <script src="./viz.js" defer></script>
	  </body>
	</html>
